#!/bin/bash

set -euo pipefail
echo "Starting automated Hyprland setup..."

# --- Variables ---
DOTFILES_REPO="https://github.com/GalT45/dotfiles.git"
DOTFILES_DIR="$HOME/dotfiles"
WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
WALLPAPER_IMAGE="$WALLPAPER_DIR/default.jpg"

# --- Update system and install essential packages ---
sudo pacman -Syu --noconfirm
sudo pacman -S --noconfirm hyprland kitty rofi grim slurp wlogout git base-devel

# --- Install yay (AUR helper) if not installed ---
if ! command -v yay &> /dev/null; then
    git clone https://aur.archlinux.org/yay.git /tmp/yay
    cd /tmp/yay
    makepkg -si --noconfirm
    cd
    rm -rf /tmp/yay
fi

# --- Install AUR packages ---
yay -S --noconfirm librewolf-bin nwg-look swww waybar udiskie python-pywal16 matugen-bin hypridle hyprlock kvantum kvantum-qt5

# --- Clone public dotfiles ---
if [ ! -d "$DOTFILES_DIR" ]; then
    git clone "$DOTFILES_REPO" "$DOTFILES_DIR"
fi

echo "Copying dotfiles..."
cp -r "$DOTFILES_DIR/.config/hypr" "$HOME/.config/"
cp -r "$DOTFILES_DIR/.config/kitty" "$HOME/.config/"
cp -r "$DOTFILES_DIR/.config/rofi" "$HOME/.config/"
cp -r "$DOTFILES_DIR/.config/waybar" "$HOME/.config/"
cp -r "$DOTFILES_DIR/.config/swww" "$HOME/.config/"
cp -r "$DOTFILES_DIR/.zshrc" "$HOME/"

# --- Install and configure Zsh & Oh-My-Zsh ---
sudo pacman -S --noconfirm zsh
chsh -s /usr/bin/zsh

if [ ! -d "$HOME/.oh-my-zsh" ]; then
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Install zsh syntax highlighting plugin
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting

# --- Setup GTK and Kvantum themes ---
git clone https://github.com/vinceliuice/Graphite-gtk-theme.git /tmp/Graphite-gtk-theme
cd /tmp/Graphite-gtk-theme
./install.sh -l --tweaks nord rimless normal
cd
rm -rf /tmp/Graphite-gtk-theme

git clone https://github.com/vinceliuice/Graphite-kde-theme.git /tmp/Graphite-kde-theme
cd /tmp/Graphite-kde-theme
./install.sh --rimless
cd
rm -rf /tmp/Graphite-kde-theme

# --- Wallpaper setup ---
mkdir -p "$WALLPAPER_DIR"
if [ ! -f "$WALLPAPER_IMAGE" ]; then
    cp "$DOTFILES_DIR/wallpapers/default.jpg" "$WALLPAPER_IMAGE"
fi

# Start swww daemon and set wallpaper
swww-daemon & disown
swww img "$WALLPAPER_IMAGE"

# --- Start Waybar ---
waybar & disown

# --- Install power-profiles-daemon ---
sudo pacman -S --noconfirm power-profiles-daemon
sudo systemctl enable --now power-profiles-daemon

# --- Launch Hyprland ---
echo "Setup complete! You can now launch Hyprland with the command: Hyprland"

