#!/bin/bash

set -euo pipefail

echo "=== Starting automated Hyprland setup ==="

# --- Variables ---
DOTFILES_REPO="https://github.com/GalT45/dotfiles.git"
DOTFILES_DIR="$HOME/dotfiles"
WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
WALLPAPER_IMAGE="$WALLPAPER_DIR/default.jpg"

# --- Step 1: Update system ---
echo "1/10: Updating system..."
sudo pacman -Syu --noconfirm

# --- Step 2: Install essential packages ---
echo "2/10: Installing essential packages..."
sudo pacman -S --noconfirm hyprland kitty rofi grim slurp git base-devel zsh

# --- Step 3: Install yay if not installed ---
echo "3/10: Installing yay (AUR helper)..."
if ! command -v yay &> /dev/null; then
    git clone https://aur.archlinux.org/yay.git /tmp/yay
    cd /tmp/yay
    makepkg -si --noconfirm
    cd
    rm -rf /tmp/yay
else
    echo "yay already installed"
fi

# --- Step 4: Install AUR packages ---
echo "4/10: Installing AUR packages..."
yay -S --noconfirm librewolf-bin nwg-look swww waybar udiskie wlogout python-pywal16 matugen-bin hypridle hyprlock kvantum kvantum-qt5

# --- Step 5: Clone dotfiles ---
echo "5/10: Cloning dotfiles..."
if [ ! -d "$DOTFILES_DIR" ]; then
    git clone "$DOTFILES_REPO" "$DOTFILES_DIR"
else
    echo "Dotfiles directory already exists, pulling latest..."
    cd "$DOTFILES_DIR" && git pull
fi

# --- Step 6: Copy configs ---
mkdir -p "$HOME/.config"

copy_if_exists() {
    if [ -d "$DOTFILES_DIR/.config/$1" ]; then
        echo "Copying $1 config..."
        cp -r "$DOTFILES_DIR/.config/$1" "$HOME/.config/"
    else
        echo "Skipping $1 (no directory in dotfiles)"
    fi
}

copy_if_exists hypr
copy_if_exists kitty
copy_if_exists rofi
copy_if_exists waybar
copy_if_exists wlogout
copy_if_exists swaync

# --- Step 7: Zsh & Oh-My-Zsh ---
echo "7/10: Installing Oh-My-Zsh..."
chsh -s /usr/bin/zsh || true
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi
git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting || true

# --- Step 8: GTK & Kvantum themes ---
echo "8/10: Installing Graphite GTK & Kvantum themes..."
git clone https://github.com/vinceliuice/Graphite-gtk-theme.git /tmp/Graphite-gtk-theme
cd /tmp/Graphite-gtk-theme
./install.sh -l --tweaks nord rimless normal
cd
rm -rf /tmp/Graphite-gtk-theme

git clone https://github.com/vinceliuice/Graphite-kde-theme.git /tmp/Graphite-kde-theme
cd /tmp/Graphite-kde-theme
./install.sh --rimless
cd
rm -rf /tmp/Graphite-kde-theme

# --- Step 9: Wallpaper setup ---
echo "9/10: Setting up wallpaper..."
mkdir -p "$WALLPAPER_DIR"
if [ ! -f "$WALLPAPER_IMAGE" ]; then
    cp "$DOTFILES_DIR/wallpapers/default.jpg" "$WALLPAPER_IMAGE" || true
fi
swww-daemon & disown
swww img "$WALLPAPER_IMAGE"

# --- Step 10: Start Waybar & power profiles ---
echo "10/10: Starting Waybar and power-profiles-daemon..."
waybar & disown
sudo pacman -S --noconfirm power-profiles-daemon
sudo systemctl enable --now power-profiles-daemon

echo "=== Setup complete! You can now launch Hyprland with: Hyprland ==="

